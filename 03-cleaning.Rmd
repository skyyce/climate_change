# Data transformation


```{r}
library(ggplot2)
library(dplyr)
library(latex2exp)
library(tidyverse)
library(zoo)
```
## Data for patterns of climate change
```{r}
temp <- read.table("data/raw/GLB.Ts+dSST.csv", header = TRUE, skip = 1, sep = ",")
temp_monthly <- temp %>% select(-J.D, -D.N, -DJF, -MAM, -JJA, -SON) %>% 
  transform(Nov = as.double(Nov), Dec = as.double(Dec)) %>% 
  pivot_longer(cols = !Year, names_to = "Month", values_to = "temp") %>% 
  transform(time = as.yearmon(paste(Month, Year))) %>% 
  select(time, temp)
write.csv(temp_monthly, "data/clean/temp_monthly.csv", row.names = FALSE)
```


```{r}
temp_yearly <- temp %>% select(Year, J.D) %>% 
  transform(J.D = as.double(J.D)) %>% 
  rename(temp = J.D)
write.csv(temp_yearly, "data/clean/temp_yearly.csv", row.names = FALSE)
```

## Data for causes of climate change
In this part, except the temperature data, we use the data about Earth's orbit and solar irradiation, and the data about greenhouse gas. For the Milankovitch orbital data, we choose to download the data from 2800s BC to now on the [website](https://biocycle.atmos.colostate.edu/shiny/Milankovitch/), and select the variables that is helpful for us to solve problems. The data of four greenhouse gases are separated, so we write functions to read mole fraction data and growth rate data, and combine the data of four gases into one table. For the convenience of following table combination and plotting, the time variables in the tables are transformed to the same format.


```{r}
read_greenHouseGas <- function(file){
  GAS <- read.table(file, header = FALSE, comment.char = "#")
  GAS <- GAS %>% select(V1, V2, V3, V4) %>% rename(year = V1, month = V2, decimal = V3, gas = V4)
  GAS$time <- as.yearmon(paste(GAS$year, GAS$month), "%Y %m")
  GAS <- GAS %>% select(time, decimal, gas)
}
```

```{r}
CO2 <- read_greenHouseGas("https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_gl.txt")
CO2 <- CO2 %>% rename(CO2 = gas)
CH4 <- read_greenHouseGas("https://gml.noaa.gov/webdata/ccgg/trends/ch4/ch4_mm_gl.txt")
CH4 <- CH4 %>% rename(CH4 = gas)
N2O <- read_greenHouseGas("https://gml.noaa.gov/webdata/ccgg/trends/n2o/n2o_mm_gl.txt")
N2O <- N2O %>% rename(N2O = gas)
SF6 <- read_greenHouseGas("https://gml.noaa.gov/webdata/ccgg/trends/sf6/sf6_mm_gl.txt")
SF6 <- SF6 %>% rename(SF6 = gas)
```

```{r}
gh_gas <- CO2 %>% full_join(CH4, by = c("time" = "time", "decimal" = "decimal")) %>% full_join(N2O, by = c("time" = "time", "decimal" = "decimal")) %>% full_join(SF6, by = c("time" = "time", "decimal" = "decimal")) 
write.csv(gh_gas, "data/clean/gh_gas_monthly.csv", row.names = FALSE)
```

```{r}
read_gasGrowthRate <- function(file){
  GAS <- read.table(file, header = FALSE, comment.char = "#")
  GAS <- GAS %>% select(V1, V2) %>% rename(year = V1, rate = V2)
}
```

```{r}
CO2_rate = read_gasGrowthRate("https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_gr_gl.txt") %>% rename(CO2 = rate)
CH4_rate = read_gasGrowthRate("https://gml.noaa.gov/webdata/ccgg/trends/ch4/ch4_gr_gl.txt") %>% rename(CH4 = rate)
N2O_rate = read_gasGrowthRate("https://gml.noaa.gov/webdata/ccgg/trends/n2o/n2o_gr_gl.txt") %>% rename(N2O = rate)
SF6_rate = read_gasGrowthRate("https://gml.noaa.gov/webdata/ccgg/trends/sf6/sf6_gr_gl.txt") %>% rename(SF6 = rate)
```


```{r}
gas_rate <- CO2_rate %>% full_join(CH4_rate, by = c("year" = "year")) %>% full_join(N2O_rate, by = c("year" = "year")) %>% full_join(SF6_rate, by = c("year" = "year")) %>% filter(year >= 1980)
write.csv(gas_rate, "data/clean/gas_rate_yearly.csv", row.names = FALSE)
```

## Data for effects of climate change
In this part, we use 3 data set from NASA_EARTH_DATA. These three data sets are about ice sheet mass in Antarctic, ice sheet mass in Greenland and Global sea level change. These data sets are in txt. files, so we just simply read the table. You can view these data on [website1](https://podaac-tools.jpl.nasa.gov/drive/files/allData/tellus/L4/ice_mass/RL06/v02/mascon_CRI//antarctica_mass_200204_202109.txt)
[website2](https://podaac-tools.jpl.nasa.gov/drive/files/allData/merged_alt/L2/TP_J1_OSTM/global_mean_sea_level//GMSL_TPJAOS_5.1_199209_202108.txt)
[website3](http://podaac.jpl.nasa.gov/dataset/MERGED_TP_J1_OSTM_OST_ALL_V51)

```{r}
df <- read.table("data/clean/ice_sheet_antarctica_mass_200204_202109.txt",
                 skip=31,
                 col.names = c('TIME', 'antarctica', 'antarctica_sigma'))
```

```{r}
dt <- read.table("data/clean/ice_sheet_greenland_mass_200204_202109.txt",
                 skip=31,
                 col.names = c('TIME', 'greenland', 'greenland_sigma'))
```

```{r}
tt <- read.table("data/clean/sea_level_GMSL_TPJAOS_5.1_199209_202108.txt", skip = 48)
head(tt)
```
Another data set we use is from NOAA database. You can view these data on [website4](https://www.climate.gov/maps-data/dataset/severe-storms-and-extreme-events-data-table) Since every year's data is gathered in one csv. file and we wants to use data from 2000 to 2021, we download the 22 csv. files into one folder and then try to compile all the data into one csv. file.
```{r}
library(readr)
library(data.table)
library(tidyverse)

dir = "data/clean/stormevents_2000_2021"  # Search the file under some specific directory 
#get the csv file list
file_list = list.files(path = dir, pattern = "*.csv$",recursive = TRUE,full.names = TRUE)    
#form a new place to save the csv file
store_csv = "data/clean/stormevents_2000_2021_new.csv" #paste(dir,"new.csv")       

for(i in 1:length(file_list))     #loop
{
    df = fread(file = file_list[i],encoding = 'UTF-8')         #read the csv files
    #if not exist, then write a new csv file
    write_csv(df,path = store_csv,append = TRUE, col_names = FALSE)              
    
}

stormevents_2000_2021_new <- read_csv("data/clean/stormevents_2000_2021_new.csv")


```